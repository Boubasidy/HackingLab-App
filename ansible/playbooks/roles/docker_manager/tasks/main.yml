---
# tasks/main.yml — création du pool de conteneurs

- name: Créer plusieurs conteneurs Docker
  community.docker.docker_container:
    name: "env_{{ item }}"
    image: "{{ docker_env_image }}"
    published_ports:
      - "{{ docker_base_port + item }}:22"
    restart_policy: always
    detach: true
  loop: "{{ range(1, (nb_env | int) + 1) | list }}"
  register: containers

# Construire la liste docker_infos au nouveau format
- name: Construire la liste des conteneurs
  set_fact:
    docker_infos: "{{ docker_infos | default([]) + [ {
        'name': (item.container.Name | regex_replace('^/', '')),
        'id': item.container.Id,
        'ip_address': item.container.NetworkSettings.Networks.bridge.IPAddress,
        'ssh_port': (docker_base_port + ((item.container.Name | regex_replace('^/env_', '')) | int)),
        'username': 'user1',
        'password': None,
        'owner': None,
        'reserved_until': None
      } ] }}"
  loop: "{{ containers.results }}"

- name: Sauvegarder les infos d'accès dans un JSON
  copy:
    dest: "{{ json_output_path }}"
    content: "{{ docker_infos | to_nice_json }}"
