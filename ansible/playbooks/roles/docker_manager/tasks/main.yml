---
# tasks/main.yml

- name: Créer plusieurs conteneurs Docker
  community.docker.docker_container:
    name: "env_{{ item }}"
    image: "{{ docker_env_image }}"
    published_ports:
      - "{{ docker_base_port + item }}:22"
    restart_policy: always
    detach: true
  loop: "{{ range(1, (nb_env | int) + 1) | list }}"
  register: containers

# Récupérer les infos utiles : nom, IP, port exposé
- name: Extraire les infos utiles des conteneurs créés
  set_fact:
    docker_infos: "{{ docker_infos | default([]) + [ {
        'name': item.container.Name,
        'ip_address': item.container.NetworkSettings.Networks.bridge.IPAddress,
        'ssh_port': docker_base_port + (item.container.Name | regex_replace('^env_', '') | int)
      } ] }}"
  loop: "{{ containers.results }}"



# Ajout d’un mot de passe SSH fixe pour les tests
# (dans un vrai environnement, on génèrera ou échangera des clés SSH)
- name: Ajouter mot de passe SSH aux infos
  set_fact:
    docker_infos: >-
      {{
        docker_infos | map('combine', {'username': 'root', 'password': 'vagrant'}) | list
      }}


- name: Sauvegarder les infos d'accès dans un JSON
  copy:
    dest: "{{ json_output_path }}"
    content: "{{ docker_infos | to_nice_json }}"

