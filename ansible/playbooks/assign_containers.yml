---
- name: Assigner des conteneurs à un utilisateur et appliquer le mot de passe
  hosts: localhost
  connection: local
  gather_facts: no
  become: yes

  vars:
    json_output_path: /srv/infrastructure/ansible/environnements.json

  tasks:
    - name: Lire le fichier environnements.json
      slurp:
        src: "{{ json_output_path }}"
      register: env_file

    - name: Charger le JSON en structure Python
      set_fact:
        docker_infos: "{{ env_file.content | b64decode | from_json }}"

    - name: Calculer la liste des conteneurs libres (owner == null)
      set_fact:
        free_containers: "{{ docker_infos | selectattr('owner', 'equalto', None) | list }}"

    - name: Vérifier qu'il y a assez de conteneurs libres
      fail:
        msg: "Pas assez de conteneurs libres (disponibles={{ free_containers | length }}, demandés={{ requested | int }})"
      when: (free_containers | length) < (requested | int)

    - name: Sélectionner les noms des conteneurs à assigner
      set_fact:
        selected_names: "{{ (free_containers | map(attribute='name') | list)[: (requested | int)] }}"

    - name: Initialiser la liste mise à jour
      set_fact:
        updated_docker_infos: []

    - name: Mettre à jour owner/password pour les conteneurs sélectionnés
      set_fact:
        updated_docker_infos: "{{ updated_docker_infos + [ (
          item
          | combine({
              'owner': (username if (item.name in selected_names) else item.owner),
              'password': (ssh_password if (item.name in selected_names) else item.password)
            })
        ) ] }}"
      loop: "{{ docker_infos }}"

    - name: Sauvegarder les infos mises à jour dans le JSON (atomique)
      copy:
        dest: "{{ json_output_path }}.tmp"
        content: "{{ updated_docker_infos | to_nice_json }}"
      run_once: true

    - name: Déplacer le JSON temporaire en place
      command: mv "{{ json_output_path }}.tmp" "{{ json_output_path }}"
      run_once: true

    - name: Afficher les conteneurs assignés
      debug:
        var: selected_names

    ##################################################
    # --- Tâches pour appliquer le mot de passe SSH ---
    ##################################################

    - name: Construire une liste d'objets des conteneurs assignés (avec username)
      set_fact:
        assigned_objects: "{{ updated_docker_infos | selectattr('name', 'in', selected_names) | list }}"

    - name: Appliquer le mot de passe et activer l'authentification par mot de passe
      vars:
        target_name: "{{ item.name }}"
        target_user: "{{ item.username | default('root') }}"
        target_pass: "{{ item.password | default(ssh_password) }}"
      command: >
        docker exec {{ target_name }} bash -lc
        "set -e
         # activer PasswordAuthentication et PermitRootLogin si présents/commentés
         if grep -q '^#\\?PasswordAuthentication' /etc/ssh/sshd_config; then
           sed -ri 's/^#?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config || true
         else
           echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config
         fi
         if grep -q '^#\\?PermitRootLogin' /etc/ssh/sshd_config; then
           sed -ri 's/^#?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config || true
         else
           echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config
         fi
         # appliquer mot de passe
         echo \"{{ target_user }}:{{ target_pass }}\" | chpasswd
         # redémarrer ssh
         if command -v service >/dev/null 2>&1; then service ssh restart || /etc/init.d/ssh restart || true; fi
         exit 0"
      loop: "{{ assigned_objects }}"
      loop_control:
        label: "{{ item.name }}"
      register: apply_pass_results
      changed_when: "'exit 0' in apply_pass_results.stdout or apply_pass_results.rc == 0"
      failed_when: apply_pass_results.rc != 0 and apply_pass_results.rc is not none
